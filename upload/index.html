<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Connector Manifest Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2962ff;
      --danger: #d32f2f;
      --gray: #666;
      --border: #cfd8dc;
      --bg: #fafafa;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --max: 1280px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: var(--font);
      margin: 0;
      background: #fff;
      color: #111;
      line-height: 1.5;
    }
    header {
      width: 100%;
      background: #fff;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 2;
    }
    header .wrap {
      max-width: var(--max);
      margin: 0 auto;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.35rem;
    }
    .btn {
      display: inline-block;
      padding: .6rem 1rem;
      background: var(--primary);
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      white-space: nowrap;
    }
    .btn.secondary { background: #607d8b; }
    .btn.ghost {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .btn:disabled { background: #9aa7ff; cursor: not-allowed; }
    main {
      max-width: var(--max);
      margin: 0 auto;
      padding: 2rem 1.25rem 4rem;
    }
    .lead {
      color: var(--gray);
      margin-top: .5rem;
      font-size: 1.05rem;
      max-width: 840px;
    }
    #controls {
      margin: 1.25rem 0 2rem;
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
    }
    #dropzone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 2rem 1rem;
      text-align: center;
      color: #455a64;
      background: var(--bg);
      font-size: 1rem;
      min-height: 35vh;            /* ~ ekranın 1/3'ü */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all .15s ease;
    }
    #dropzone.dragover {
      background: #e8f0ff;
      border-color: var(--primary);
      color: var(--primary);
    }
    #dropzone strong { font-size: 1.1rem; }
    .hint { color: var(--gray); margin-top: .35rem; }
    input[type="text"] {
      width: 100%;
      max-width: 640px;
      padding: .65rem .8rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      margin-top: .25rem;
    }
    #uploadBtn { margin-top: 1rem; }
    #status {
      margin-top: 1.25rem;
      font-size: 1rem;
      max-width: 840px;
      word-break: break-word;
    }
    pre {
      background: #f5f5f5;
      padding: .9rem;
      overflow: auto;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: .9rem;
      max-height: 320px;
      margin-top: .75rem;
    }
    .hidden { display: none !important; }
    footer {
      max-width: var(--max);
      margin: 2rem auto 0;
      padding: 1.25rem;
      border-top: 1px solid var(--border);
      color: var(--gray);
      font-size: .9rem;
    }
    code { font-family: var(--mono); }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Connector Manifest Uploader</h1>
    <div>
      <a id="viewDocsBtn" class="btn ghost" target="_blank" rel="noopener">
        View Docs Site
      </a>
    </div>
  </div>
</header>

<main>
  <p class="lead">
    1) <strong>Sign in with GitHub</strong> → 2) <strong>Drag & drop</strong> your <code>.yaml</code>, <code>.yml</code> or <code>.json</code> → 3) <strong>Upload</strong>.<br/>
    In ~30–60 seconds your connector documentation will be live on the site.
  </p>

  <div id="controls">
    <button id="loginBtn" class="btn">Sign in with GitHub</button>
    <button id="logoutBtn" class="btn secondary hidden">Clear Session (info)</button>
  </div>

  <div id="dropzone">
    <strong>Drop your manifest file here</strong>
    <div class="hint">Supported: .yaml, .yml, .json (single file)</div>
    <input id="fileInput" type="file" accept=".yaml,.yml,.json" class="hidden" />
    <p class="hint" style="margin-top:.8rem;">or <a href="#" id="browseLink">browse</a></p>
  </div>

  <section style="margin-top:2rem; max-width:840px;">
    <label for="commitMsg"><strong>Commit message (optional)</strong></label>
    <input id="commitMsg" type="text" placeholder="Add my-connector.yaml" />
    <br/>
    <button id="uploadBtn" class="btn" disabled>Upload</button>
  </section>

  <div id="status"></div>
  <pre id="log" class="hidden"></pre>
</main>

<footer>
  Worker endpoint: <code id="workerUrl"></code><br/>
  Tip: If you receive <code>401 Unauthorized</code>, click <strong>Sign in with GitHub</strong> again.
</footer>

<script>
  // ======= CONFIG =======
  const WORKER_BASE_URL = "https://connector-uploader-worker.e-ayvaz.workers.dev";
  const DOCS_BASE_URL   = "https://ernayvaz.github.io/datahub-connector-docs/";
  // ======================

  document.getElementById('workerUrl').textContent = WORKER_BASE_URL;
  const viewDocsBtn = document.getElementById('viewDocsBtn');
  viewDocsBtn.href = DOCS_BASE_URL;

  const loginBtn    = document.getElementById('loginBtn');
  const logoutBtn   = document.getElementById('logoutBtn');
  const uploadBtn   = document.getElementById('uploadBtn');
  const dropzone    = document.getElementById('dropzone');
  const statusEl    = document.getElementById('status');
  const logEl       = document.getElementById('log');
  const commitMsgEl = document.getElementById('commitMsg');
  const fileInput   = document.getElementById('fileInput');
  const browseLink  = document.getElementById('browseLink');

  let selectedFile = null;
  let fileName     = null;
  let loggedIn     = false;

  // UI state
  function setLoggedInUI(isLoggedIn) {
    loggedIn = isLoggedIn;
    loginBtn.classList.toggle('hidden', isLoggedIn);
    logoutBtn.classList.toggle('hidden', !isLoggedIn);
    uploadBtn.disabled = !isLoggedIn || !selectedFile;
  }
  setLoggedInUI(false);

  loginBtn.addEventListener('click', () => {
    window.location.href = WORKER_BASE_URL + "/login";
  });

  logoutBtn.addEventListener('click', () => {
    alert("The access token is stored as an HttpOnly cookie on the Worker domain, so the page cannot clear it.\nClose the browser or use a private window to start a new session.");
  });

  // Drag & drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  ['dragenter', 'dragover'].forEach(evt => {
    dropzone.addEventListener(evt, () => dropzone.classList.add('dragover'));
  });
  ['dragleave', 'drop'].forEach(evt => {
    dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover'));
  });

  dropzone.addEventListener('drop', (e) => {
    const files = e.dataTransfer?.files || [];
    handleFiles(files);
  });

  browseLink.addEventListener('click', (e) => {
    e.preventDefault();
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    const files = e.target.files || [];
    handleFiles(files);
  });

  function handleFiles(files) {
    if (!files || !files.length) return;
    const file = files[0];
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    if (!['yaml', 'yml', 'json'].includes(ext)) {
      showStatus("Only .yaml / .yml / .json files are allowed.", true);
      return;
    }
    selectedFile = file;
    fileName = file.name;
    showStatus(`Selected file: ${file.name}`);
    uploadBtn.disabled = !loggedIn;
  }

  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile) {
      showStatus("No file selected.", true);
      return;
    }

    uploadBtn.disabled = true;
    showStatus("Reading file...");

    try {
      const text = await selectedFile.text();
      const base64Content = toBase64(text);
      const commitMessage = commitMsgEl.value || `Add ${fileName}`;

      showStatus("Uploading to repository via Worker...");

      const resp = await fetch(WORKER_BASE_URL + "/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ filename: fileName, base64Content, commitMessage })
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        if (resp.status === 401) {
          setLoggedInUI(false);
          showStatus("Unauthorized. Please click 'Sign in with GitHub' again.", true);
        } else if (resp.status === 403) {
          showStatus("Forbidden origin. Check ALLOWED_ORIGIN on the Worker.", true, data);
        } else {
          showStatus(`Upload failed: ${resp.status} ${resp.statusText}`, true, data);
        }
      } else {
        setLoggedInUI(true);
        // Build a guess URL: connectors/<slug>/
        const slug = guessSlugFromFilename(fileName);
        const guessedUrl = DOCS_BASE_URL + "connectors/" + slug + "/";
        showStatus(
          `Done! Committed to ${data.path}. The site will rebuild & publish in ~30–60s.\n` +
          `You can try the documentation page here (guess): ${guessedUrl}`,
          false,
          { ...data, guessed_url: guessedUrl }
        );
      }

    } catch (err) {
      showStatus("Unexpected error: " + (err?.message || err), true);
    } finally {
      uploadBtn.disabled = false;
    }
  });

  function showStatus(msg, isError = false, obj = undefined) {
    statusEl.textContent = msg;
    statusEl.style.color = isError ? 'var(--danger)' : 'green';
    if (obj) {
      logEl.classList.remove('hidden');
      logEl.textContent = JSON.stringify(obj, null, 2);
    } else {
      logEl.classList.add('hidden');
      logEl.textContent = "";
    }
  }

  function toBase64(str) {
    const uint8 = new TextEncoder().encode(str);
    let binary = '';
    uint8.forEach(b => binary += String.fromCharCode(b));
    return btoa(binary);
  }

  function guessSlugFromFilename(name) {
    return name
      .replace(/\.[^.]+$/, '')   // strip extension
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '_') // safe-ish (mkdocs pages usually with _)
      .replace(/^_+|_+$/g, '');
  }
</script>
</body>
</html>
