<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Connector Manifest Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2962ff;
      --danger: #d32f2f;
      --gray: #777;
      --border: #cfd8dc;
      --bg: #fafafa;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    body {
      font-family: var(--font);
      margin: 2rem;
      background: #fff;
      color: #111;
    }
    .container {
      max-width: 820px; margin: 0 auto;
    }
    h1 { margin-bottom: .5rem; }
    p.lead { color: var(--gray); margin-top: 0; }
    .btn {
      display: inline-block;
      padding: .6rem 1rem;
      background: var(--primary);
      color: #fff;
      border-radius: 4px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .btn.secondary { background: #607d8b; }
    .btn:disabled { background: #9aa7ff; cursor: not-allowed; }
    #dropzone {
      border: 2px dashed var(--border);
      border-radius: 6px;
      padding: 2.2rem 1rem;
      text-align: center;
      color: #455a64;
      margin-top: 1rem;
      transition: all .15s ease;
      background: var(--bg);
      font-size: 0.95rem;
    }
    #dropzone.dragover {
      background: #e8f0ff;
      border-color: var(--primary);
      color: var(--primary);
    }
    input[type="text"] {
      width: 100%;
      padding: .55rem .7rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.95rem;
    }
    pre {
      background: #f5f5f5;
      padding: .75rem;
      overflow: auto;
      border-radius: 4px;
      font-family: var(--mono);
      font-size: .85rem;
      max-height: 260px;
    }
    #status { margin-top: 1rem; font-size: 0.95rem; }
    footer {
      margin-top: 3rem; font-size: .85rem; color: var(--gray);
      border-top: 1px solid var(--border);
      padding-top: 1rem;
    }
    code { font-family: var(--mono); }
    small.hint { color: var(--gray); display: block; margin-top: .25rem; }
    .hidden { display:none; }
  </style>
</head>
<body>
<div class="container">
  <h1>Connector Manifest Uploader</h1>
  <p class="lead">
    1) <strong>Sign in with GitHub</strong> → 2) <strong>Drag & drop</strong> your <code>.yaml</code>, <code>.yml</code> or <code>.json</code> → 3) <strong>Upload</strong>.<br/>
    In ~30–60 seconds your connector documentation will be live on the site.
  </p>

  <p>
    <button id="loginBtn" class="btn">Sign in with GitHub</button>
    <button id="logoutBtn" class="btn secondary hidden">Clear Session (info)</button>
  </p>

  <div id="dropzone">
    <strong>Drop your manifest file here</strong><br/>
    <small class="hint">Supported: .yaml, .yml, .json (single file)</small>
    <input id="fileInput" type="file" accept=".yaml,.yml,.json" class="hidden" />
    <p style="margin-top:.5rem;">
      or <a href="#" id="browseLink">browse</a>
    </p>
  </div>

  <p style="margin-top:1rem;">
    <label for="commitMsg">Commit message (optional)</label><br/>
    <input id="commitMsg" type="text" placeholder="Add my-connector.yaml" />
  </p>

  <p>
    <button id="uploadBtn" class="btn" disabled>Upload</button>
  </p>

  <div id="status"></div>
  <pre id="log" class="hidden"></pre>

  <footer>
    Worker endpoint: <code id="workerUrl"></code><br/>
    Tip: If you receive <code>401 Unauthorized</code>, click <strong>Sign in with GitHub</strong> again.
  </footer>
</div>

<script>
  // === CONFIG ===
  const WORKER_BASE_URL = "https://connector-uploader-worker.e-ayvaz.workers.dev";
  // ==============

  document.getElementById('workerUrl').textContent = WORKER_BASE_URL;

  const loginBtn   = document.getElementById('loginBtn');
  const logoutBtn  = document.getElementById('logoutBtn');
  const uploadBtn  = document.getElementById('uploadBtn');
  const dropzone   = document.getElementById('dropzone');
  const statusEl   = document.getElementById('status');
  const logEl      = document.getElementById('log');
  const commitMsgEl= document.getElementById('commitMsg');
  const fileInput  = document.getElementById('fileInput');
  const browseLink = document.getElementById('browseLink');

  let selectedFile = null;
  let fileName     = null;
  let loggedIn     = false; // We can't read the HttpOnly cookie; we'll infer via /upload response.

  // UI helpers
  function setLoggedInUI(isLoggedIn) {
    loggedIn = isLoggedIn;
    loginBtn.classList.toggle('hidden', isLoggedIn);
    logoutBtn.classList.toggle('hidden', !isLoggedIn);
    uploadBtn.disabled = !isLoggedIn || !selectedFile;
  }

  function showStatus(msg, isError = false, obj = undefined) {
    statusEl.textContent = msg;
    statusEl.style.color = isError ? 'var(--danger)' : 'green';
    if (obj) {
      logEl.classList.remove('hidden');
      logEl.textContent = JSON.stringify(obj, null, 2);
    } else {
      logEl.classList.add('hidden');
      logEl.textContent = '';
    }
  }

  // default: we don't know if logged in → show login button
  setLoggedInUI(false);

  loginBtn.addEventListener('click', () => {
    window.location.href = WORKER_BASE_URL + "/login";
  });

  // HttpOnly cookie cannot be cleared from JS; just show info
  logoutBtn.addEventListener('click', () => {
    alert("Because the access token is stored in an HttpOnly cookie on the Worker domain, the page cannot clear it.\nClose the browser or use a private window to start a new session.");
  });

  // Drag & drop listeners
  ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  ;['dragenter', 'dragover'].forEach(evt => {
    dropzone.addEventListener(evt, () => dropzone.classList.add('dragover'));
  });

  ;['dragleave', 'drop'].forEach(evt => {
    dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover'));
  });

  dropzone.addEventListener('drop', async (e) => {
    const files = e.dataTransfer?.files || [];
    handleFiles(files);
  });

  browseLink.addEventListener('click', (e) => {
    e.preventDefault();
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    const files = e.target.files || [];
    handleFiles(files);
  });

  async function handleFiles(files) {
    if (!files || !files.length) return;
    const file = files[0];
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    if (!['yaml', 'yml', 'json'].includes(ext)) {
      showStatus("Only .yaml / .yml / .json files are allowed.", true);
      return;
    }
    selectedFile = file;
    fileName = file.name;
    showStatus(`Selected file: ${file.name}`, false);
    uploadBtn.disabled = !loggedIn;
  }

  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile) {
      showStatus("No file selected.", true);
      return;
    }

    uploadBtn.disabled = true;
    showStatus("Reading file...", false);

    try {
      const text = await selectedFile.text();
      const base64Content = toBase64(text);
      const commitMessage = commitMsgEl.value || `Add ${fileName}`;

      showStatus("Uploading to repository via Worker...", false);

      const resp = await fetch(WORKER_BASE_URL + "/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include", // include HttpOnly cookie
        body: JSON.stringify({ filename: fileName, base64Content, commitMessage })
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        if (resp.status === 401) {
          setLoggedInUI(false);
          showStatus("Unauthorized. Please click 'Sign in with GitHub' again.", true);
        } else if (resp.status === 403) {
          showStatus("Forbidden origin. Check ALLOWED_ORIGIN on the Worker.", true, data);
        } else {
          showStatus(`Upload failed: ${resp.status} ${resp.statusText}`, true, data);
        }
      } else {
        setLoggedInUI(true);
        showStatus(`Done! Committed to ${data.path}. The site will rebuild & publish in ~30–60s.`, false, data);
      }

    } catch (err) {
      showStatus("Unexpected error: " + (err?.message || err), true);
    } finally {
      uploadBtn.disabled = false;
    }
  });

  // Safe unicode → base64
  function toBase64(str) {
    const uint8 = new TextEncoder().encode(str);
    let binary = '';
    uint8.forEach(b => binary += String.fromCharCode(b));
    return btoa(binary);
  }
</script>
</body>
</html>
